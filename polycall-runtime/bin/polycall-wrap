#!/bin/bash
# PolyCall Wrapper with Telemetry

POLYCALL_BIN="${POLYCALL_HOME}/bin/polycall"
TELEMETRY_LOG="${POLYCALL_LOG_DIR}/telemetry/commands.log"

# Ensure telemetry directory exists
mkdir -p "$(dirname "$TELEMETRY_LOG")"

# Log command execution
echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] CMD: polycall $*" >> "$TELEMETRY_LOG"

# Execute with timing
START_TIME=$(date +%s%N)
"$POLYCALL_BIN" "$@"
EXIT_CODE=$?
END_TIME=$(date +%s%N)

# Calculate duration in milliseconds
DURATION=$(( (END_TIME - START_TIME) / 1000000 ))

# Log result
echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] RESULT: exit_code=$EXIT_CODE duration_ms=$DURATION" >> "$TELEMETRY_LOG"

exit $EXIT_CODE
